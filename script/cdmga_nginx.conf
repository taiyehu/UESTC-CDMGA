server {
    listen 80;  # 监听 80 端口

    server_name  localhost;

 client_max_body_size 3M;

    # ===============================================================
    # 规则 1: 代理所有 /api/ 开头的请求到后端服务
    # ===============================================================
    location /api/ {
        # 如果没有 cookie，重定向到挑战页
        if ($cookie_js_challenge != "1") {
            return 302 /__challenge.html;
        }
        # proxy_pass 指向你的后端服务地址
        # **注意**: 末尾没有斜杠 /，这样 Nginx 会将原始请求的完整路径 (/api/...) 附加到后面
        # 例如, /api/users 会被转发到 http://localhost:8080/api/users
        proxy_pass http://localhost:8080;

        # ---- 重要的代理头设置 ----
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # ---- WebSocket 支持 (已按要求注释) ----
        # proxy_http_version 1.1;
        # proxy_set_header Upgrade $http_upgrade;
        # proxy_set_header Connection "upgrade";
    }

    # ===============================================================
    # 规则 2: 代理所有其他请求到前端服务
    # ===============================================================
    location / {
        # 指向你的前端服务地址
        root /var/www/CDMGA-ui;
        index index.html;
        try_files $uri $uri/ /index.html;

    }
    location /images/ {
        alias /var/webserver/images/;
    }
    location /scores/ {
        alias /var/webserver/scores/;
    }
    location /avatars/ {
        alias /var/webserver/avatars/;
    }

    # 挑战页：用 JS 写入 cookie 并回跳，curl 不会执行
    location = /__challenge.html {
        add_header Content-Type text/html;
        return 200 '
    <!doctype html><html><head><meta charset="utf-8"><title>Checking...</title></head><body>
    <script>
      document.cookie = "js_challenge=1;path=/;max-age=600;SameSite=Lax";
      var r = document.referrer || "/";
      location.href = r;
    </script>
    <p>验证中...</p>
    </body></html>';
        }
    }

    # 您可以添加访问日志和错误日志的路径
    access_log /var/log/nginx/cdmga.access.log;
    error_log /var/log/nginx/cdmga.error.log;
}
